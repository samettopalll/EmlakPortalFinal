@{
    ViewBag.Title = "My Listings";
}

<div class="btn-group" style="position:absolute;right:50px;top:70px">
    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split p-2" data-bs-toggle="dropdown" aria-expanded="false">İlan Ekle
        <span class="visually-hidden">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="/Home/AddLand">Arsa İlanı Ekle</a></li>
        <li><a class="dropdown-item" href="/Home/AddProperty">Konut İlanı Ekle</a></li>
    </ul>
</div>

<div id="listingsContainer" class="mt-5">
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var token = localStorage.getItem("token");

            if (token == null) {
                window.location.href = "/Login";
            }

            var uid = '';
            var payload = parseJwt(token);
            uid = payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"];

            $.ajax({
                url: 'https://localhost:7023/api/Lands/UsersLands',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function (response) {
                    renderListings(response, 1);
                },
                error: function (xhr, status, error) {
                    console.log("Error in loading land listings: " + status + " - " + error);
                }
            });

            $.ajax({
                url: 'https://localhost:7023/api/Properties/UsersProperties',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function (response) {
                    renderListings(response, 2);
                },
                error: function (xhr, status, error) {
                    console.log("Error in loading property listings: " + status + " - " + error);
                }
            });

            function renderListings(listings, categoryID) {
                var listingsHtml = '';
                listings.forEach(function (listing) {
                    var detailsUrl = categoryID === 1 ? '/Home/LandDetails/' : '/Home/PropertyDetails/';
                    listingsHtml += `
                                <div class="listing">
                                    <h3>${listing.title}</h3>
                                    <p>${listing.description}</p>
                                    <p>Price: ${listing.price}₺</p>
                                    <p>Location: ${listing.location}</p>
                                    <p>Created: ${formatDate(listing.created)}</p>
                                    <p>Updated: ${formatDate(listing.updated)}</p>
                                    <a href="${detailsUrl}${listing.id}" class="btn btn-primary">Görüntüle</a>
                                    <a href="${categoryID === 1 ? '/Home/EditLand/' : '/Home/EditProperty/'}${listing.id}" class="btn btn-secondary">Düzenle</a>
                                    <a href="${categoryID === 1 ? '/Home/DeleteLand/' : '/Home/DeleteProperty/'}${listing.id}" class="btn btn-danger">Sil</a>
                                </div>
                                <hr>
                            `;
                });
                $('#listingsContainer').append(listingsHtml);
            }

            function formatDate(dateString) {
                if (!dateString) return '';
                var date = new Date(dateString);
                var day = date.getDate() > 9 ? date.getDate() : '0' + date.getDate();
                var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : '0' + (date.getMonth() + 1);
                var year = date.getFullYear();
                var hour = date.getHours() > 9 ? date.getHours() : '0' + date.getHours();
                var minute = date.getMinutes() > 9 ? date.getMinutes() : '0' + date.getMinutes();
                var second = date.getSeconds() > 9 ? date.getSeconds() : '0' + date.getSeconds();
                return day + "." + month + "." + year + " " + hour + ":" + minute + ":" + second;
            }

            function parseJwt(token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }
        });
    </script>
}
